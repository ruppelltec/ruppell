name: Deploy Ruppell

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [self-hosted]

    env:
      # Ruta al directorio que contiene docker-compose.yml
      COMPOSE_DIR: ruppell
      DOMAIN: ruppelltec.com
      CERTBOT_EMAIL: admin@ruppelltec.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker permissions
        run: |
          sudo usermod -aG docker $USER || true
          sudo chmod 666 /var/run/docker.sock || true
          docker --version
          docker-compose version

      - name: Create environment file
        run: |
          cd "${COMPOSE_DIR}"
          cat > .env <<EOF
          VITE_SERVER_URL=https://${DOMAIN}
          VITE_API_BASE_URL=https://${DOMAIN}/api
          VITE_API_VERSION=v1
          VITE_FRONT_USERNAME_API=${{ vars.API_USERNAME }}
          VITE_FRONT_PASSWORD_API=${{ vars.API_PASSWORD }}
          EOF

      - name: Build images
        run: |
          cd "${COMPOSE_DIR}"
          docker-compose build --no-cache

      - name: Start services
        run: |
          cd "${COMPOSE_DIR}"
          # Stop/remove containers only (no volumes) to apply changes cleanly
          docker-compose down --remove-orphans || true
          docker-compose up -d

      - name: Ensure services are running
        run: |
          cd "${COMPOSE_DIR}"
          docker-compose ps

          # Espera corta para que nginx termine de iniciar/reiniciar
          sleep 5

          # Si nginx no estÃ¡ "Up", falla
          docker-compose ps | grep -q "nginx" || exit 1
          docker-compose ps | grep -q "Up" || (docker-compose ps && exit 1)

      - name: Reload nginx after cert attempts (best effort)
        run: |
          cd "${COMPOSE_DIR}"
          # Si certbot renueva/emite, nginx debe recargar para tomar el nuevo cert
          docker-compose exec -T nginx nginx -s reload || true

      - name: Show logs on failure
        if: failure()
        run: |
          cd "${COMPOSE_DIR}"
          echo "=== docker-compose ps ==="
          docker-compose ps || true
          echo "=== nginx logs (last 120) ==="
          docker-compose logs nginx --tail=120 || true
          echo "=== certbot logs (last 120) ==="
          docker-compose logs certbot --tail=120 || true
