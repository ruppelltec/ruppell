name: Deploy Ruppell

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [self-hosted]

    env:
      DOMAIN: ruppelltec.com
      CERTBOT_EMAIL: ruppelltec@gmail.com
      APP_DIR: ruppell
      COMPOSE_FILE: ruppell/docker-compose.yml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker check + pick compose command
        shell: bash
        run: |
          set -euo pipefail
          docker --version

          if docker compose version >/dev/null 2>&1; then
            echo "COMPOSE_CMD=docker compose" >> $GITHUB_ENV
            docker compose version
          elif command -v docker-compose >/dev/null 2>&1; then
            echo "COMPOSE_CMD=docker-compose" >> $GITHUB_ENV
            docker-compose version
          else
            echo "ERROR: No compose available (docker compose / docker-compose)."
            exit 1
          fi

          # Info útil, pero no rompe el job
          docker buildx version || true

      - name: Create environment file
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          cat > .env <<EOF
          VITE_SERVER_URL=https://${DOMAIN}
          VITE_API_BASE_URL=https://${DOMAIN}/api
          VITE_API_VERSION=v1
          VITE_FRONT_USERNAME_API=${{ vars.API_USERNAME }}
          VITE_FRONT_PASSWORD_API=${{ vars.API_PASSWORD }}
          EOF

      - name: Build & start services
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"

          # Baja stack anterior (sin borrar volúmenes) y levanta
          $COMPOSE_CMD -f docker-compose.yml down --remove-orphans || true
          $COMPOSE_CMD -f docker-compose.yml up -d --build

      - name: Verify containers running
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          $COMPOSE_CMD -f docker-compose.yml ps
          sleep 5
          $COMPOSE_CMD -f docker-compose.yml ps | grep -q "nginx" || exit 1
          $COMPOSE_CMD -f docker-compose.yml ps | grep -q "Up" || exit 1

      - name: Reload nginx (best effort)
        shell: bash
        run: |
          cd "$APP_DIR"
          $COMPOSE_CMD -f docker-compose.yml exec -T nginx nginx -s reload || true

      - name: Show logs on failure
        if: failure()
        shell: bash
        run: |
          cd "$APP_DIR"
          echo "=== compose ps ==="
          $COMPOSE_CMD -f docker-compose.yml ps || true
          echo "=== nginx logs (last 120) ==="
          $COMPOSE_CMD -f docker-compose.yml logs nginx --tail=120 || true
          echo "=== certbot logs (last 120) ==="
          $COMPOSE_CMD -f docker-compose.yml logs certbot --tail=120 || true
