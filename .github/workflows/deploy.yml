name: Deploy Ruppell

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: [self-hosted]

    env:
      DOMAIN: ruppelltec.com
      CERTBOT_EMAIL: ruppelltec@gmail.com

    steps:
      - uses: actions/checkout@v4

      - name: Docker info
        shell: bash
        run: |
          set -euo pipefail
          docker --version
          docker-compose version

      - name: Locate docker-compose.yml
        shell: bash
        run: |
          set -euo pipefail
          COMPOSE_PATH="$(find . -maxdepth 6 -type f -name 'docker-compose.yml' | head -n 1)"
          if [ -z "${COMPOSE_PATH:-}" ]; then
            echo "ERROR: docker-compose.yml not found in repo."
            exit 1
          fi
          echo "COMPOSE_PATH=$COMPOSE_PATH" >> $GITHUB_ENV
          echo "COMPOSE_DIR=$(dirname "$COMPOSE_PATH")" >> $GITHUB_ENV
          echo "Found: $COMPOSE_PATH"

      - name: Create .env next to compose
        shell: bash
        run: |
          set -euo pipefail
          cd "$COMPOSE_DIR"
          cat > .env <<EOF
          VITE_SERVER_URL=https://${DOMAIN}
          VITE_API_BASE_URL=https://${DOMAIN}/api
          VITE_API_VERSION=v1
          VITE_FRONT_USERNAME_API=${{ vars.API_USERNAME }}
          VITE_FRONT_PASSWORD_API=${{ vars.API_PASSWORD }}
          EOF

      - name: Deploy
        shell: bash
        run: |
          set -euo pipefail
          cd "$COMPOSE_DIR"

          docker-compose down --remove-orphans || true
          docker-compose up -d --build
          docker-compose ps

      - name: Verify
        shell: bash
        run: |
          set -euo pipefail
          cd "$COMPOSE_DIR"
          docker-compose ps
          docker-compose ps | grep -q "nginx" || exit 1
          docker-compose ps | grep -q "Up" || exit 1

      - name: Logs on failure
        if: failure()
        shell: bash
        run: |
          cd "$COMPOSE_DIR" || exit 0
          echo "=== docker-compose ps ==="
          docker-compose ps || true
          echo "=== nginx logs (last 120) ==="
          docker-compose logs nginx --tail=120 || true
          echo "=== certbot logs (last 120) ==="
          docker-compose logs certbot --tail=120 || true
