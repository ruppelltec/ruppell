name: Deploy Ruppell

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [ruppell-core]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Limpiar logs de nginx antes de build
        run: |
          sudo rm -rf nginx/logs/* || true

      - name: Setup Docker permissions
        run: |
          sudo usermod -aG docker $USER || true
          sudo chmod 666 /var/run/docker.sock || true
          docker --version
          
      - name: Create environment file
        run: |
          echo "VITE_API_BASE_URL=https://${{ vars.DOMAIN }}/api" >> .env
          echo "VITE_API_VERSION=v1" >> .env
          echo "VITE_FRONT_USERNAME_API=${{ vars.API_USERNAME }}" >> .env
          echo "VITE_FRONT_PASSWORD_API=${{ vars.API_PASSWORD }}" >> .env
          # PORT lo gestionan los servicios en docker-compose, no aqu√≠

      - name: Complete system cleanup before deploy
        run: |
          docker-compose down -v --remove-orphans || true
          
          docker system prune -f --volumes --all || true
          
          npm cache clean --force || true
          rm -rf node_modules || true
          
          rm -rf dist build logs nginx/cache || true
          
          df -h
          docker system df

      - name: Ensure Docker network and volumes exist
        run: |
          docker network inspect linker-network >/dev/null 2>&1 || docker network create linker-network
          docker volume inspect certbot-etc >/dev/null 2>&1 || docker volume create certbot-etc
          docker volume inspect certbot-var >/dev/null 2>&1 || docker volume create certbot-var
          
      - name: Build and start services (sin nginx)
        env:
          VITE_SERVER_URL: https://${{ vars.DOMAIN }}
        run: |
          docker-compose build --no-cache
          docker-compose up -d frontend

      - name: Ensure SSL certificate exists (self-signed fallback)
        env:
          DOMAIN: ${{ vars.DOMAIN }}

        run: |
          set -e
          echo "üîç Verificando si existe certificado para $DOMAIN..."

          # Usamos SIEMPRE el volumen 'certbot-etc' (external en docker-compose)
          VOLUME_NAME="certbot-etc"

          # ¬øExiste ya el certificado?
          if docker run --rm -v "$VOLUME_NAME":/etc/letsencrypt alpine \
              sh -c "test -f /etc/letsencrypt/live/$DOMAIN/fullchain.pem"; then
            echo "‚úÖ Certificado existente encontrado, no se genera self-signed."
          else
            echo "‚ö†Ô∏è No se encontr√≥ certificado, generando self-signed temporal..."
            docker run --rm -v "$VOLUME_NAME":/etc/letsencrypt alpine sh -c "
              apk add --no-cache openssl && \
              mkdir -p /etc/letsencrypt/live/$DOMAIN && \
              openssl req -x509 -nodes -days 30 -newkey rsa:2048 \
                -keyout /etc/letsencrypt/live/$DOMAIN/privkey.pem \
                -out /etc/letsencrypt/live/$DOMAIN/fullchain.pem \
                -subj \"/CN=$DOMAIN\"
            "
            echo '‚úÖ Certificado self-signed generado y guardado en el volumen certbot-etc.'
          fi

      - name: Start nginx
        run: |
          docker-compose up -d nginx
          
          echo "Waiting for nginx to start..."
          sleep 10
          
          echo "‚úÖ Nginx started (HTTP y HTTPS configurados)"

      - name: Verify domain connectivity
        run: |
          set -e
          echo 'üåê Verificando conectividad del dominio...'
          DOMAIN="${{ vars.DOMAIN }}"
          
          echo "üì° Verificando DNS para $DOMAIN..."
          nslookup "$DOMAIN" || echo "‚ö†Ô∏è DNS lookup failed"
          
          echo "üîå Verificando conectividad HTTP..."
          curl -v --connect-timeout 10 "http://$DOMAIN/.well-known/acme-challenge/test" || echo "‚ö†Ô∏è HTTP connection failed (es normal si el archivo no existe)"
          
          echo "üè† Verificando nginx interno..."
          docker-compose exec nginx curl -s -o /dev/null -w "%{http_code}\n" http://localhost/api/health || echo "‚ö†Ô∏è Internal nginx check failed"

      - name: Obtener/renovar certificado SSL con Certbot (webroot)
        env:
          CERTBOT_EMAIL: bscantor3@gmail.com
          DOMAIN: ${{ vars.DOMAIN }}

        run: |
          echo "üîê Intentando obtener/renovar certificado SSL (webroot)..."
          
          set +e
          docker-compose run --rm certbot certonly \
            --webroot -w /var/www/certbot \
            --email "$CERTBOT_EMAIL" \
            --agree-tos --no-eff-email \
            -d "$DOMAIN"
          CERTBOT_EXIT=$?
          set -e
          
          if [ "$CERTBOT_EXIT" -eq 0 ]; then
            echo "‚úÖ Certbot completado correctamente, recargando nginx..."
            docker-compose exec nginx nginx -s reload || true
          else
            echo "‚ö†Ô∏è Certbot fall√≥ (rate limit o problema de HTTP/DNS)."
            echo "   Se mantiene el certificado actual (self-signed o el √∫ltimo v√°lido)."
          fi

      - name: SSL Setup Troubleshooting
        if: failure()
        run: |
          echo "üîß Troubleshooting SSL setup..."
          echo "=== Container Status ==="
          docker-compose ps
          echo "=== Nginx Logs ==="
          docker-compose logs nginx --tail=50 || true
          echo "=== Certbot Logs ==="
          docker-compose logs certbot --tail=50 || echo "No certbot logs found"
          echo "=== Network Status ==="
          docker network ls
          docker network inspect linker-network || echo "Network not found"
          
          echo "üí° SSL setup failed, pero el despliegue puede seguir con el certificado actual."

      - name: Verify deployment
        run: |
          echo "‚úÖ Verificando contenedores en ejecuci√≥n..."
          docker-compose ps
          
      - name: Post-deploy cleanup
        if: always()
        run: |
          docker system prune -f || true
          npm cache clean --force || true
          
          echo "=== Final Disk Usage ==="
          df -h
          echo "=== Final Docker Usage ==="
          docker system df

      - name: Show service logs
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker-compose ps
          echo "=== Service Logs (√∫ltimos 50 logs por servicio) ==="
          docker-compose logs --tail=50 || true
